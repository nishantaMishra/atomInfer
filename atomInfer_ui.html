<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AtomInfer ‚Äî Experimental Data ‚Üí Atomistic Model</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">

<style>
:root {
  --bg:#0a0c10;--panel:#0f1219;--border:#1e2535;--border2:#2a3450;
  --accent:#3d7eff;--accent2:#00e5c8;--warn:#f7b731;--good:#26de81;
  --text:#c8d3e8;--text-dim:#5a6785;--glow:rgba(61,126,255,0.15);--glow2:rgba(0,229,200,0.1);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;font-size:15.4px;min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;background-image:linear-gradient(rgba(61,126,255,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(61,126,255,0.03) 1px,transparent 1px);background-size:40px 40px;}
header{position:relative;z-index:10;border-bottom:1px solid var(--border);padding:0 2rem;display:flex;align-items:center;justify-content:space-between;height:60px;background:rgba(10,12,16,0.95);backdrop-filter:blur(20px);}
.logo{display:flex;align-items:center;gap:12px;}
.logo-mark{width:32px;height:32px;border:1.5px solid var(--accent);border-radius:6px;display:flex;align-items:center;justify-content:center;box-shadow:0 0 12px var(--glow);}
.logo-mark::after{content:'‚¨°';color:var(--accent);font-size:17.6px;}
.logo-text{font-family:'Space Mono',monospace;font-size:17.6px;font-weight:700;color:#fff;letter-spacing:-0.5px;}
.logo-text span{color:var(--accent2);}
.header-meta{font-family:'Space Mono',monospace;font-size:12.1px;color:var(--text-dim);display:flex;gap:1.5rem;}
.status-dot{width:6px;height:6px;border-radius:50%;background:var(--good);display:inline-block;margin-right:5px;animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:0.4;}}
.layout{position:relative;z-index:1;display:grid;grid-template-columns:280px 1fr 1fr 320px;grid-template-rows:1fr;height:calc(100vh - 88px);max-height:calc(100vh - 88px);overflow:hidden;gap:0;}
.panel{border-right:1px solid var(--border);overflow-y:auto;min-height:0;scrollbar-width:thin;scrollbar-color:var(--border2) transparent;}
.panel:last-child{border-right:none;}
.panel-header{padding:14px 18px 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:rgba(15,18,25,0.97);backdrop-filter:blur(10px);z-index:5;}
.panel-title{font-family:'Space Mono',monospace;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:#ffffff;}
.panel-badge{font-family:'Space Mono',monospace;font-size:11px;padding:2px 8px;border-radius:3px;border:1px solid var(--border2);color:var(--text-dim);}
.panel-badge.active{border-color:var(--accent);color:var(--accent);box-shadow:0 0 6px var(--glow);}
.left-panel{background:var(--panel);}
.struct-panel{background:var(--bg);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;min-height:0;}
#structViewport{flex:1;min-height:0;max-height:calc(100% - 180px);position:relative;background:#070a0e;overflow:hidden;}
#structViewport canvas.struct-main-canvas{width:100%!important;height:100%!important;display:block;}
#structControls{position:absolute;top:10px;right:10px;display:none;flex-direction:column;gap:5px;z-index:10;}
#structControls button{width:34px;height:34px;border:1px solid rgba(61,126,255,0.35);border-radius:7px;background:rgba(7,10,14,0.82);color:var(--text);font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;backdrop-filter:blur(6px);padding:0;line-height:1;}
#structControls button:hover{border-color:var(--accent);color:var(--accent);background:rgba(61,126,255,0.18);box-shadow:0 0 8px var(--glow);}
#structControls button.active{border-color:var(--accent2);color:var(--accent2);background:rgba(0,229,200,0.12);}
#structLegend{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);display:none;gap:5px;flex-wrap:wrap;justify-content:center;z-index:10;pointer-events:none;max-width:calc(100% - 100px);}
.leg-pill{display:flex;align-items:center;gap:5px;padding:4px 10px 4px 7px;border-radius:20px;background:rgba(7,10,14,0.78);border:1px solid rgba(255,255,255,0.13);backdrop-filter:blur(5px);}
.leg-dot{width:13px;height:13px;border-radius:50%;flex-shrink:0;box-shadow:0 0 4px rgba(255,255,255,0.2);}
.leg-label{font-family:'Space Mono',monospace;font-size:10.5px;color:#fff;white-space:nowrap;}
#axisCanvas{position:absolute;bottom:10px;left:10px;width:100px!important;height:100px!important;min-width:100px;min-height:100px;z-index:10;pointer-events:none;display:none;}
.struct-summary{height:180px;overflow-y:auto;border-top:1px solid var(--border);background:var(--panel);padding:12px 14px;scrollbar-width:thin;scrollbar-color:var(--border2) transparent;}
.lat-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;}
.lat-item{background:rgba(61,126,255,0.05);border:1px solid var(--border2);border-radius:6px;padding:8px 10px;}
.lat-key{font-family:'Space Mono',monospace;font-size:9.9px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:2px;}
.lat-val{font-family:'Space Mono',monospace;font-size:13.2px;color:var(--accent2);font-weight:700;}
.section{padding:16px 18px;border-bottom:1px solid var(--border);}
.section-label{font-family:'Space Mono',monospace;font-size:11px;color:#ffffff;text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;}
.upload-zone{border:1.5px dashed var(--border2);border-radius:8px;padding:20px 16px;text-align:center;cursor:pointer;transition:all 0.2s;background:rgba(61,126,255,0.02);position:relative;}
.upload-zone.has-file{border-color:var(--accent2);background:var(--glow2);border-style:solid;}
.upload-icon{font-size:26.4px;margin-bottom:8px;display:block;}
.upload-label{font-family:'Space Mono',monospace;font-size:12.1px;color:var(--text-dim);line-height:1.6;}
.upload-label strong{color:var(--text);}
.upload-zone input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;}
.technique-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;}
.technique-btn{padding:8px 10px;border:1px solid var(--border2);border-radius:6px;background:transparent;cursor:pointer;text-align:left;transition:all 0.15s;color:var(--text-dim);font-family:'Space Mono',monospace;font-size:11px;letter-spacing:0.5px;}
.technique-btn:hover{border-color:var(--accent);color:var(--text);}
.technique-btn.active{border-color:var(--accent);background:var(--glow);color:var(--accent);box-shadow:0 0 8px var(--glow);}
.technique-btn .tech-icon{font-size:15.4px;display:block;margin-bottom:3px;}
.sample-list{display:flex;flex-direction:column;gap:4px;}
.sample-item{padding:8px 10px;border:1px solid var(--border);border-radius:5px;cursor:pointer;display:flex;align-items:center;justify-content:space-between;transition:all 0.15s;}
.sample-item:hover{border-color:var(--border2);background:rgba(255,255,255,0.02);}
.sample-item.active{border-color:var(--accent2);background:var(--glow2);}
.sample-name{font-size:13.2px;color:var(--text);}
.sample-tag{font-family:'Space Mono',monospace;font-size:9.9px;padding:2px 6px;border-radius:3px;background:rgba(255,255,255,0.05);color:var(--text-dim);}
.sample-item.active .sample-tag{background:rgba(0,229,200,0.1);color:var(--accent2);}
.run-btn{width:100%;padding:12px;border:1px solid var(--accent);border-radius:8px;background:var(--glow);color:var(--accent);font-family:'Space Mono',monospace;font-size:13.2px;font-weight:700;letter-spacing:1px;cursor:pointer;text-transform:uppercase;transition:all 0.2s;position:relative;overflow:hidden;}
.run-btn:hover{background:rgba(61,126,255,0.2);box-shadow:0 0 20px var(--glow);}
.run-btn:disabled{opacity:0.4;cursor:not-allowed;}
.center-panel{background:var(--bg);border-right:1px solid var(--border);display:flex;flex-direction:column;min-height:0;overflow:hidden;}
.log-container{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:12px;scrollbar-width:thin;scrollbar-color:var(--border2) transparent;}
.msg{display:flex;gap:10px;align-items:flex-start;animation:fadeSlideIn 0.3s ease;}
@keyframes fadeSlideIn{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:translateY(0);}}
.msg-avatar{width:28px;height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:14.3px;margin-top:2px;}
.msg.agent .msg-avatar{background:rgba(61,126,255,0.15);border:1px solid rgba(61,126,255,0.3);}
.msg.tool  .msg-avatar{background:rgba(0,229,200,0.1);border:1px solid rgba(0,229,200,0.25);}
.msg.user  .msg-avatar{background:rgba(247,183,49,0.1);border:1px solid rgba(247,183,49,0.3);}
.msg.result .msg-avatar{background:rgba(38,222,129,0.1);border:1px solid rgba(38,222,129,0.3);}
.msg-content{flex:1;min-width:0;}
.msg-header{display:flex;align-items:center;gap:8px;margin-bottom:5px;}
.msg-role{font-family:'Space Mono',monospace;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;}
.msg.agent .msg-role{color:var(--accent);}
.msg.tool  .msg-role{color:var(--accent2);}
.msg.user  .msg-role{color:var(--warn);}
.msg.result .msg-role{color:var(--good);}
.msg-time{font-family:'Space Mono',monospace;font-size:9.9px;color:var(--text-dim);}
.msg-text{font-size:14.3px;line-height:1.65;color:var(--text);}
.tool-call{background:rgba(0,229,200,0.04);border:1px solid rgba(0,229,200,0.15);border-left:3px solid var(--accent2);border-radius:0 6px 6px 0;padding:10px 12px;font-family:'Space Mono',monospace;font-size:12.1px;margin-top:5px;}
.tool-name{color:var(--accent2);font-weight:700;margin-bottom:4px;}
.tool-args{color:var(--text-dim);white-space:pre-wrap;word-break:break-all;}
.tool-result{background:rgba(38,222,129,0.04);border:1px solid rgba(38,222,129,0.15);border-left:3px solid var(--good);border-radius:0 6px 6px 0;padding:10px 12px;font-family:'Space Mono',monospace;font-size:12.1px;margin-top:5px;}
.kv-grid{display:grid;grid-template-columns:auto 1fr;gap:2px 12px;}
.kv-key{color:var(--text-dim);font-size:11px;white-space:nowrap;}
.kv-val{color:var(--good);font-size:11px;}
.kv-val.highlight{color:var(--accent2);font-weight:700;font-size:12.1px;}
.kv-val.warn{color:var(--warn);}
.typing{display:flex;align-items:center;gap:10px;padding:6px 0;}
.typing-dots{display:flex;gap:4px;}
.typing-dots span{width:4px;height:4px;border-radius:50%;background:var(--accent);animation:blink 1.2s infinite;}
.typing-dots span:nth-child(2){animation-delay:0.2s;}
.typing-dots span:nth-child(3){animation-delay:0.4s;}
@keyframes blink{0%,80%,100%{opacity:0.2;}40%{opacity:1;}}
.typing-label{font-family:'Space Mono',monospace;font-size:11px;color:var(--text-dim);}
.progress-bar-wrap{padding:12px 20px;border-top:1px solid var(--border);background:var(--panel);}
.progress-steps{display:flex;gap:4px;margin-bottom:8px;}
.progress-step{flex:1;height:3px;border-radius:2px;background:var(--border2);transition:background 0.4s;}
.progress-step.done{background:var(--accent);}
.progress-step.active{background:var(--accent2);animation:shimmer 1.5s infinite;}
@keyframes shimmer{0%,100%{opacity:1;}50%{opacity:0.5;}}
.progress-label{font-family:'Space Mono',monospace;font-size:11px;color:var(--text-dim);display:flex;justify-content:space-between;}
.progress-label span{color:var(--accent2);}
.right-panel{background:var(--panel);}
.metric-card{padding:12px 14px;border-bottom:1px solid var(--border);}
.metric-card-label{font-family:'Space Mono',monospace;font-size:9.9px;text-transform:uppercase;letter-spacing:1px;color:var(--text-dim);margin-bottom:3px;}
.metric-value{font-family:'Space Mono',monospace;font-size:22px;font-weight:700;color:var(--text);line-height:1.1;}
.metric-value.accent{color:var(--accent);}
.metric-value.accent2{color:var(--accent2);}
.metric-value.good{color:var(--good);}
.metric-value.warn{color:var(--warn);}
.metric-unit{font-size:12.1px;font-weight:400;color:var(--text-dim);margin-left:3px;}
.metric-delta{font-family:'Space Mono',monospace;font-size:11px;margin-top:2px;}
.metric-delta .up{color:var(--good);}
.metric-delta .dn{color:#ff6b6b;}
.metrics-row{display:grid;grid-template-columns:1fr 1fr;border-bottom:1px solid var(--border);}
.metrics-row .metric-card{border-bottom:none;border-right:1px solid var(--border);}
.metrics-row .metric-card:last-child{border-right:none;}
.comp-bar-wrap{padding:14px 16px;border-bottom:1px solid var(--border);}
.comp-bar{height:8px;border-radius:4px;background:var(--border2);overflow:hidden;margin:8px 0;display:flex;}
.comp-segment{height:100%;transition:width 1s cubic-bezier(0.4,0,0.2,1);}
.comp-legend{display:flex;flex-wrap:wrap;gap:8px;font-family:'Space Mono',monospace;font-size:9.9px;}
.comp-legend-item{display:flex;align-items:center;gap:4px;color:var(--text-dim);}
.comp-dot{width:8px;height:8px;border-radius:2px;}
.chart-area{padding:14px 16px;border-bottom:1px solid var(--border);}
.chart-canvas-wrap{height:100px;position:relative;margin-top:8px;}
canvas.mini-chart{width:100%;height:100%;display:block;}
.file-list{padding:10px 14px;}
.file-item{display:flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--border);border-radius:5px;margin-bottom:6px;cursor:pointer;transition:all 0.15s;}
.file-item:hover{border-color:var(--accent);background:var(--glow);}
.file-icon{font-family:'Space Mono',monospace;font-size:12.1px;padding:2px 5px;border-radius:3px;background:rgba(61,126,255,0.1);color:var(--accent);}
.file-name{font-size:13.2px;color:var(--text);flex:1;}
.file-size{font-family:'Space Mono',monospace;font-size:11px;color:var(--text-dim);}
.gauge-wrap{padding:16px;display:flex;flex-direction:column;align-items:center;border-bottom:1px solid var(--border);}
.gauge-svg{width:140px;height:80px;}
.empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 20px;text-align:center;color:var(--text-dim);min-height:200px;}
.empty-icon{font-size:35.2px;margin-bottom:12px;opacity:0.4;}
.empty-text{font-family:'Space Mono',monospace;font-size:12.1px;line-height:1.7;}
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}
.demo-banner{position:relative;z-index:10;padding:8px 2rem;background:rgba(247,183,49,0.06);border-bottom:1px solid rgba(247,183,49,0.2);display:flex;align-items:center;gap:10px;font-family:'Space Mono',monospace;font-size:12.1px;color:var(--warn);}
#hrmcOverlay{position:absolute;top:10px;left:10px;display:none;flex-direction:column;gap:4px;z-index:10;pointer-events:none;}
.hrmc-stat{font-family:'Space Mono',monospace;font-size:11px;padding:3px 8px;border-radius:4px;background:rgba(7,10,14,0.85);border:1px solid rgba(0,229,200,0.35);color:var(--accent2);backdrop-filter:blur(6px);}
.hrmc-btn{border-color:var(--accent2)!important;color:var(--accent2)!important;background:var(--glow2)!important;}
.hrmc-btn:hover{background:rgba(0,229,200,0.18)!important;box-shadow:0 0 20px var(--glow2)!important;}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
</head>
<body>

<div class="demo-banner">
  ‚ö° DEMO MODE ‚Äî  <!-- Running on Nikhil's Ce-doped LiMn‚ÇÇO‚ÇÑ XRD dataset &nbsp;|&nbsp;-->
  AtomInfer - By Nikhil, Nishant and Anirban
</div>

<header>
  <div class="logo">
    <div class="logo-mark"></div>
    <div class="logo-text">Atom<span>Infer</span></div>
  </div>
  <div class="header-meta">
    <span><span class="status-dot"></span>AGENT READY</span>
    <span>v2.0 ¬∑ Penn State CHE</span>
  </div>
</header>

<div class="layout">
  <!-- LEFT -->
  <div class="panel left-panel">
    <div class="panel-header">
      <span class="panel-title">Input Configuration</span>
      <span class="panel-badge active">CONFIGURED</span>
    </div>
    <div class="section">
      <div class="section-label">Input File</div>
      <div class="upload-zone has-file">
        <span class="upload-icon">üìä</span>
        <div class="upload-label">
          <strong>XRD_Data_-_Nikhil.xlsx</strong><br>
          Rigaku ¬∑ Cu KŒ± ¬∑ 4 sheets<br>
          <span style="color:var(--accent2);">‚úì loaded</span>
        </div>
      </div>
    </div>
    <div class="section">
      <div class="section-label">Additional Techniques</div>
      <div class="technique-grid">
        <button class="technique-btn active" onclick="toggleTech(this,'xrd')"><span class="tech-icon">‚ö°</span>XRD</button>
        <button class="technique-btn" onclick="toggleTech(this,'raman')"><span class="tech-icon">üåà</span>Raman</button>
        <button class="technique-btn" onclick="toggleTech(this,'afm')"><span class="tech-icon">üî¨</span>AFM</button>
        <button class="technique-btn" onclick="toggleTech(this,'xps')"><span class="tech-icon">‚öõÔ∏è</span>XPS</button>
      </div>
    </div>
    <div class="section">
      <div class="section-label">Domain Knowledge</div>
      <div style="display:flex;flex-direction:column;gap:8px;">
        <textarea id="dkInput" rows="5" placeholder="Enter domain knowledge (free text). You can include 'Ce: 1%' or similar to set numeric values." style="padding:8px;border:1px solid var(--border);border-radius:6px;background:transparent;color:var(--text);font-family:'Space Mono',monospace;font-size:13.2px;resize:vertical;" onblur="applyDomainKnowledge(false)"></textarea>
      </div>
    </div>
    <div class="section">
      <div class="section-label">Materials Project</div>
        <div id="mpResults" style="margin-top:8px;max-height:260px;overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--border2) transparent;"></div>
    </div>
    <div class="section">
      <button class="run-btn" id="runBtn" onclick="startAnalysis()">‚ñ∂ RUN ATOMINFER</button>
    </div>
    <div class="section">
      <div class="section-label">HRMC Refinement</div>
      <div style="display:flex;flex-direction:column;gap:8px;">
        <div style="display:grid;grid-template-columns:auto 1fr;gap:6px;align-items:center;">
          <label style="font-family:'Space Mono',monospace;font-size:11px;color:var(--text-dim);">Ce %</label>
          <input id="hrmcCePct" type="number" min="0" max="20" step="0.5" value="5" style="padding:6px 8px;border:1px solid var(--border);border-radius:5px;background:transparent;color:var(--text);font-family:'Space Mono',monospace;font-size:12px;">
          <label style="font-family:'Space Mono',monospace;font-size:11px;color:var(--text-dim);">Steps</label>
          <input id="hrmcSteps" type="number" min="10" max="500" step="10" value="50" style="padding:6px 8px;border:1px solid var(--border);border-radius:5px;background:transparent;color:var(--text);font-family:'Space Mono',monospace;font-size:12px;">
        </div>
        <button class="run-btn hrmc-btn" id="hrmcBtn" onclick="runHRMC()">‚ö° REFINE STRUCTURE</button>
      </div>
    </div>
    <div class="section">
      <div class="section-label">Agent Settings</div>
      <div style="font-family:'Space Mono',monospace;font-size:11px;display:grid;grid-template-columns:auto 1fr;gap:4px 14px;">
        <span style="color:var(--text-dim);">LLM</span><span style="color:var(--text);">llama-3.3-70b</span>
        <span style="color:var(--text-dim);">provider</span><span style="color:var(--text);">Groq API</span>
        <span style="color:var(--text-dim);">temp</span><span style="color:var(--text);">0.05</span>
        <span style="color:var(--text-dim);">max_iter</span><span style="color:var(--text);">15</span>
        <span style="color:var(--text-dim);">tools</span><span style="color:var(--accent2);">9 registered</span>
      </div>
    </div>
  </div>

  <!-- STRUCTURE VIEWER -->
  <div class="struct-panel">
    <div class="panel-header">
      <span class="panel-title">Crystal Structure</span>
      <span class="panel-badge" id="structBadge">SELECT</span>
    </div>
    <div id="structViewport">
      <div class="empty-state" id="structEmpty">
        <div class="empty-icon">‚¨°</div>
        <div class="empty-text">Click a Materials Project<br>result to render structure</div>
      </div>
      <div id="structControls">
        <button onclick="structFullscreen()" title="Fullscreen">‚õ∂</button>
        <button onclick="structToggleBonds()" title="Toggle bonds" id="btnBonds">‚ö¨</button>
        <button onclick="structResetCamera()" title="Reset view">‚Ü∫</button>
        <button onclick="structScreenshot()" title="Screenshot">üì∑</button>
        <button onclick="structExportJSON()" title="Export JSON">‚¨á</button>
      </div>
      <div id="hrmcOverlay">
        <div class="hrmc-stat" id="hrmcStep">Step: 0/0</div>
        <div class="hrmc-stat" id="hrmcRfactor">R: ‚Äî</div>
        <div class="hrmc-stat" id="hrmcEnergy">E/atom: ‚Äî</div>
        <div class="hrmc-stat" id="hrmcXce">Ce: ‚Äî</div>
      </div>
      <!-- Slideshow overlay for hardcoded trajectory frames -->
      <div id="hrmcSlideshow" style="display:none;position:absolute;inset:0;z-index:20;background:#070a0e;flex-direction:column;align-items:center;justify-content:center;">
        <img id="hrmcFrameImg" style="max-width:100%;max-height:calc(100% - 32px);object-fit:contain;" src="">
        <div id="hrmcFrameLabel" style="font-family:'Space Mono',monospace;font-size:11px;color:var(--accent2);margin-top:4px;"></div>
      </div>
      <div id="structLegend"></div>
      <canvas id="axisCanvas"></canvas>
    </div>
    <div class="struct-summary" id="structSummary">
      <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--text-dim);font-family:'Space Mono',monospace;font-size:11px;text-align:center;">Structural summary<br>will appear here</div>
    </div>
  </div>

  <!-- CENTER -->
  <div class="center-panel">
    <div class="panel-header">
      <span class="panel-title">Agent Reasoning Trace</span>
      <span class="panel-badge" id="iterBadge">IDLE</span>
    </div>
    <div class="log-container" id="logContainer">
      <div class="empty-state" id="emptyState">
        <div class="empty-icon">üß¨</div>
        <div class="empty-text">Select a sample and press<br>RUN ATOMINFER to begin<br><br>Agent will parse XRD data,<br>query Materials Project,<br>and build an atomistic model.</div>
      </div>
    </div>
    <div class="progress-bar-wrap" id="progressWrap" style="display:none;">
      <div class="progress-steps">
        <div class="progress-step" id="step0"></div><div class="progress-step" id="step1"></div>
        <div class="progress-step" id="step2"></div><div class="progress-step" id="step3"></div>
        <div class="progress-step" id="step4"></div><div class="progress-step" id="step5"></div>
        <div class="progress-step" id="step6"></div><div class="progress-step" id="step7"></div>
      </div>
      <div class="progress-label">
        <span id="progressLabelLeft">Initializing...</span>
        <span id="progressLabelRight">0/8</span>
      </div>
    </div>
  </div>

  <!-- RIGHT -->
  <div class="panel right-panel">
    <div class="panel-header">
      <span class="panel-title">Structural Results</span>
      <span class="panel-badge" id="resultsBadge">PENDING</span>
    </div>
    <div id="resultsEmpty" class="empty-state">
      <div class="empty-icon">üìê</div>
      <div class="empty-text">Results will appear<br>as agent completes steps</div>
    </div>
    <div id="resultsContent" style="display:none;">
      <div class="metric-card">
        <div class="metric-card-label">Phase Identified</div>
        <div class="metric-value accent2" id="rPhase" style="font-size:14.3px;">LiMn‚ÇÇO‚ÇÑ spinel</div>
        <div style="font-family:'Space Mono',monospace;font-size:11px;color:var(--text-dim);margin-top:3px;">Fd-3ÃÑm (#227)</div>
      </div>
      <div class="metrics-row">
        <div class="metric-card">
          <div class="metric-card-label">Lattice a</div>
          <div class="metric-value accent" id="rLattice">‚Äî</div>
          <div class="metric-delta" id="rLatticeDelta"></div>
        </div>
        <div class="metric-card">
          <div class="metric-card-label">Crystallite D</div>
          <div class="metric-value" id="rSize">‚Äî</div>
        </div>
      </div>
      <div class="metrics-row">
        <div class="metric-card">
          <div class="metric-card-label">Ce Fraction</div>
          <div class="metric-value accent2" id="rCe">‚Äî</div>
        </div>
        <div class="metric-card">
          <div class="metric-card-label">R-factor</div>
          <div class="metric-value" id="rFactor">‚Äî</div>
        </div>
      </div>
      <div class="comp-bar-wrap">
        <div class="section-label">Supercell Composition</div>
        <div class="comp-bar">
          <div class="comp-segment" id="compLi" style="background:#3d7eff;width:14%;"></div>
          <div class="comp-segment" id="compMn" style="background:#8b5cf6;width:28%;"></div>
          <div class="comp-segment" id="compCe" style="background:#00e5c8;width:2%;"></div>
          <div class="comp-segment" id="compO"  style="background:#f97316;width:56%;"></div>
        </div>
        <div class="comp-legend">
          <div class="comp-legend-item"><div class="comp-dot" style="background:#3d7eff;"></div><span id="legLi">Li: ?</span></div>
          <div class="comp-legend-item"><div class="comp-dot" style="background:#8b5cf6;"></div><span id="legMn">Mn: ?</span></div>
          <div class="comp-legend-item"><div class="comp-dot" style="background:#00e5c8;"></div><span id="legCe">Ce: ?</span></div>
          <div class="comp-legend-item"><div class="comp-dot" style="background:#f97316;"></div><span id="legO">O: ?</span></div>
        </div>
      </div>
      <div class="chart-area">
        <div class="section-label">XRD Pattern Match</div>
        <div class="chart-canvas-wrap"><canvas id="xrdChart" class="mini-chart"></canvas></div>
        <div style="display:flex;gap:12px;margin-top:6px;font-family:'Space Mono',monospace;font-size:9.9px;color:var(--text-dim);">
          <span><span style="color:var(--accent);">‚îÄ‚îÄ</span> Simulated</span>
          <span><span style="color:var(--warn);">‚îÄ‚îÄ</span> Experimental</span>
        </div>
      </div>
      <div class="gauge-wrap">
        <div class="section-label" style="align-self:flex-start;margin-bottom:8px;">Validation Score</div>
        <svg class="gauge-svg" viewBox="0 0 140 80" id="gaugeSvg">
          <defs><linearGradient id="gaugeGrad" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stop-color="#26de81"/>
            <stop offset="40%" stop-color="#f7b731"/>
            <stop offset="100%" stop-color="#ff6b6b"/>
          </linearGradient></defs>
          <path d="M 15 70 A 55 55 0 0 1 125 70" fill="none" stroke="#1e2535" stroke-width="8" stroke-linecap="round"/>
          <path d="M 15 70 A 55 55 0 0 1 125 70" fill="none" stroke="url(#gaugeGrad)" stroke-width="8" stroke-linecap="round" stroke-dasharray="173" stroke-dashoffset="120" id="gaugeArc"/>
          <line x1="70" y1="70" x2="70" y2="22" stroke="#fff" stroke-width="1.5" stroke-linecap="round" id="gaugeNeedle" transform="rotate(-55, 70, 70)"/>
          <circle cx="70" cy="70" r="4" fill="#0f1219" stroke="#3d7eff" stroke-width="1.5"/>
          <text x="10" y="78" fill="#26de81" font-size="8" font-family="Space Mono">GOOD</text>
          <text x="108" y="78" fill="#ff6b6b" font-size="8" font-family="Space Mono">POOR</text>
          <text x="70" y="55" fill="#fff" font-size="12" text-anchor="middle" font-family="Space Mono" font-weight="700" id="gaugeLabel">‚Äî</text>
        </svg>
      </div>
      <div class="panel-header" style="position:relative;top:0;">
        <span class="panel-title">Output Files</span>
      </div>
      <div class="file-list">
        <div class="file-item"><span class="file-icon">CIF</span><span class="file-name" id="fileCifName">Waiting...</span><span class="file-size" id="fileCifSize">‚Äî</span></div>
        <div class="file-item"><span class="file-icon">POSCAR</span><span class="file-name" id="fileVaspName">Waiting...</span><span class="file-size" id="fileVaspSize">‚Äî</span></div>
      </div>
      <div id="scienceNote" style="display:none;margin:12px 14px;padding:10px 12px;border:1px solid rgba(247,183,49,0.3);border-radius:6px;background:rgba(247,183,49,0.04);">
        <div style="font-family:'Space Mono',monospace;font-size:9.9px;color:var(--warn);margin-bottom:5px;">‚ö† PHYSICAL INSIGHT</div>
        <div style="font-size:12.1px;color:var(--text);line-height:1.6;" id="scienceNoteText"></div>
      </div>
    </div>
  </div>
</div>

<script>
const SAMPLE_DATA={
  'LMO':{lattice:8.1688,size:60.2,ce:0.0,n_li:32,n_mn:64,n_ce:0,n_o:128},
  '0.5% Ce-doped':{lattice:8.1277,size:40.2,ce:0.5,n_li:32,n_mn:63,n_ce:1,n_o:128},
  '1% Ce-doped':{lattice:8.1637,size:48.2,ce:1.0,n_li:32,n_mn:63,n_ce:1,n_o:128},
  '2% Ce-doped':{lattice:8.1909,size:80.3,ce:2.0,n_li:32,n_mn:62,n_ce:2,n_o:128},
};
const STEP_LABELS=['Parse XRD file','Assign hkl peaks','Nelson-Riley extraction','Scherrer size','Query Materials Project','Build supercell','Substitute Ce','Validate R-factor'];
let currentSample={name:'1% Ce-doped',ce:1.0};
let running=false;

function toggleTech(btn,tech){if(tech==='xrd')return;btn.classList.toggle('active');}
function selectSample(el,name,ce){document.querySelectorAll('.sample-item').forEach(s=>s.classList.remove('active'));el.classList.add('active');currentSample={name,ce};}
function applyDomainKnowledge(announce=true){
  const input=document.getElementById('dkInput');
  if(!input) return;
  const txt=input.value.trim();
  if(!txt) return;
  const name = txt.split('\n')[0].slice(0,60) || 'Custom';
  // look for a numeric Ce percentage like "Ce: 1%" or "1% Ce"
  let ceVal = currentSample.ce||0.0;
  const m = txt.match(/(?:Ce[:\s]*)([0-9]+(?:\.[0-9]+)?)\s*%/i) || txt.match(/([0-9]+(?:\.[0-9]+)?)\s*%\s*Ce/i);
  if(m && m[1]) ceVal = parseFloat(m[1]);
  currentSample = {name, ce: ceVal};
  if(announce){
    addMsg('agent','ATOMINFER AGENT','ü§ñ',`Domain knowledge applied: <strong>${name}</strong> ‚Äî Ce ${ceVal}%<br>${txt}`);
  }
}

// Auto-apply domain knowledge on load if textarea has content (no announcement)
try{applyDomainKnowledge(false);}catch(e){}
function now(){return new Date().toTimeString().slice(0,8);}

function addMsg(type,role,icon,content,delay=0){
  return new Promise(r=>setTimeout(()=>{
    const e=document.getElementById('emptyState');if(e)e.remove();
    const log=document.getElementById('logContainer');
    const m=document.createElement('div');m.className=`msg ${type}`;
    m.innerHTML=`<div class="msg-avatar">${icon}</div><div class="msg-content"><div class="msg-header"><span class="msg-role">${role}</span><span class="msg-time">${now()}</span></div><div class="msg-text">${content}</div></div>`;
    log.appendChild(m);log.scrollTop=log.scrollHeight;r();
  },delay));
}
function addToolCall(name,args,delay=0){
  return new Promise(r=>setTimeout(()=>{
    const log=document.getElementById('logContainer');
    const m=document.createElement('div');m.className='msg tool';
    m.innerHTML=`<div class="msg-avatar">‚öô</div><div class="msg-content"><div class="msg-header"><span class="msg-role">TOOL CALL</span><span class="msg-time">${now()}</span></div><div class="tool-call"><div class="tool-name">‚Üí ${name}()</div><div class="tool-args">${args}</div></div></div>`;
    log.appendChild(m);log.scrollTop=log.scrollHeight;r();
  },delay));
}
function addToolResult(content,delay=0){
  return new Promise(r=>setTimeout(()=>{
    const log=document.getElementById('logContainer');
    const m=document.createElement('div');m.className='msg result';
    m.innerHTML=`<div class="msg-avatar">‚úì</div><div class="msg-content"><div class="msg-header"><span class="msg-role">TOOL RESULT</span><span class="msg-time">${now()}</span></div><div class="tool-result">${content}</div></div>`;
    log.appendChild(m);log.scrollTop=log.scrollHeight;r();
  },delay));
}
function addTyping(){
  const log=document.getElementById('logContainer');
  const el=document.createElement('div');el.id='typingIndicator';el.className='msg agent';
  el.innerHTML=`<div class="msg-avatar">ü§ñ</div><div class="msg-content"><div class="msg-header"><span class="msg-role">ATOMINFER AGENT</span><span class="msg-time">${now()}</span></div><div class="typing"><div class="typing-dots"><span></span><span></span><span></span></div><span class="typing-label">reasoning...</span></div></div>`;
  log.appendChild(el);log.scrollTop=log.scrollHeight;
}
function removeTyping(){const el=document.getElementById('typingIndicator');if(el)el.remove();}
function advanceStep(i){
  document.getElementById('progressWrap').style.display='block';
  for(let j=0;j<i;j++){const s=document.getElementById('step'+j);s.classList.add('done');s.classList.remove('active');}
  if(i<8){document.getElementById('step'+i).classList.add('active');}
  document.getElementById('progressLabelLeft').textContent=STEP_LABELS[i]||'Complete';
  document.getElementById('progressLabelRight').innerHTML=`<span>${i}</span>/8`;
  document.getElementById('iterBadge').textContent=`ITER ${i+1}`;
  document.getElementById('iterBadge').className='panel-badge active';
}
function sleep(ms){return new Promise(r=>setTimeout(r,ms));}

function showResultsPanel(){
  document.getElementById('resultsEmpty').style.display='none';
  document.getElementById('resultsContent').style.display='block';
  document.getElementById('resultsBadge').textContent='COMPLETE';
  document.getElementById('resultsBadge').className='panel-badge active';
}
function updateMetrics(data){
  const a=data.lattice.toFixed(4);
  const delta=(data.lattice-8.2480).toFixed(4);
  const dStr=delta>=0?`+${delta}`:String(delta);
  const dClass=delta>=0?'up':'dn';
  document.getElementById('rLattice').innerHTML=`${a}<span class="metric-unit">√Ö</span>`;
  document.getElementById('rLattice').className='metric-value accent';
  document.getElementById('rLatticeDelta').innerHTML=`<span class="${dClass}">${dStr} vs ICDD</span>`;
  document.getElementById('rSize').innerHTML=`${data.size.toFixed(0)}<span class="metric-unit">nm</span>`;
  document.getElementById('rCe').innerHTML=`${data.ce.toFixed(1)}<span class="metric-unit">%</span>`;
  const total=data.n_li+data.n_mn+data.n_ce+data.n_o;
  const pLi=(data.n_li/total*100).toFixed(0);
  const pMn=(data.n_mn/total*100).toFixed(0);
  const pCe=Math.max((data.n_ce/total*100).toFixed(0),1);
  const pO=(data.n_o/total*100).toFixed(0);
  document.getElementById('compLi').style.width=pLi+'%';
  document.getElementById('compMn').style.width=pMn+'%';
  document.getElementById('compCe').style.width=pCe+'%';
  document.getElementById('compO').style.width=pO+'%';
  document.getElementById('legLi').textContent=`Li: ${data.n_li}`;
  document.getElementById('legMn').textContent=`Mn: ${data.n_mn}`;
  document.getElementById('legCe').textContent=`Ce: ${data.n_ce}`;
  document.getElementById('legO').textContent=`O: ${data.n_o}`;
  const lbl=`LMO_Ce${data.ce}pct_2x2x2`;
  document.getElementById('fileCifName').textContent=`${lbl}.cif`;
  document.getElementById('fileCifSize').textContent=`~${(total*0.12).toFixed(0)} kB`;
  document.getElementById('fileVaspName').textContent=`${lbl}.vasp`;
  document.getElementById('fileVaspSize').textContent=`~${(total*0.09).toFixed(0)} kB`;
}
function updateRFactor(R){
  const Rpct=(R*100).toFixed(1);
  const el=document.getElementById('rFactor');
  const cls=R<0.15?'good':R<0.25?'accent':'warn';
  el.className=`metric-value ${cls}`;
  el.innerHTML=`${Rpct}<span class="metric-unit">%</span>`;
  const off=173*R/0.5;
  document.getElementById('gaugeArc').setAttribute('stroke-dashoffset',Math.min(off,173).toFixed(0));
  const angle=-90+180*Math.min(R/0.5,1);
  document.getElementById('gaugeNeedle').setAttribute('transform',`rotate(${angle}, 70, 70)`);
  document.getElementById('gaugeLabel').textContent=`R=${Rpct}%`;
}
function drawXRDChart(ce){
  const canvas=document.getElementById('xrdChart');
  const dpr=window.devicePixelRatio||1;
  canvas.width=canvas.offsetWidth*dpr;canvas.height=canvas.offsetHeight*dpr;
  const ctx=canvas.getContext('2d');ctx.scale(dpr,dpr);
  const W=canvas.offsetWidth,H=canvas.offsetHeight;
  ctx.clearRect(0,0,W,H);
  const peaks=[{t:18.9,I:0.55},{t:36.5,I:1.0},{t:37.8,I:0.15},{t:44.4,I:0.45},{t:58.8,I:0.30},{t:64.5,I:0.65}];
  const shift=ce*0.03;
  function lor(x,x0,g,A){return A*g*g/((x-x0)**2+g*g);}
  function draw(color,sh,noise){
    const pts=[];
    for(let i=0;i<W;i++){const t=15+(i/W)*55;let y=0;for(const p of peaks)y+=lor(t,p.t+sh,0.18,p.I);if(noise)y+=(Math.random()-0.5)*0.04;pts.push({x:i,y});}
    const mx=Math.max(...pts.map(p=>p.y));
    ctx.beginPath();ctx.strokeStyle=color;ctx.lineWidth=1.5;
    for(let i=0;i<pts.length;i++){const py=H-8-(pts[i].y/mx)*(H-16);i===0?ctx.moveTo(pts[i].x,py):ctx.lineTo(pts[i].x,py);}
    ctx.stroke();
  }
  draw('rgba(61,126,255,0.8)',0,false);
  draw('rgba(247,183,49,0.6)',shift,true);
}

// ---------- Materials Project live search while typing domain knowledge ----------
const MP_API_KEY = '6knKaDCz1C5biyGIizRthNsSrMhwCKIF';
const MP_BASE    = 'https://api.materialsproject.org';

function debounce(fn, wait){let t;return function(...args){clearTimeout(t);t=setTimeout(()=>fn.apply(this,args), wait);};}
let _lastQueriedFormula = '';

/* ‚îÄ‚îÄ Formula extractor ‚Äî ported from elementsEncoding.py ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   Mirrors the character-by-character walk in elementsEncoding.py exactly:
     ‚Ä¢ uppercase char ‚Üí start of element symbol
     ‚Ä¢ if next char is lowercase ‚Üí try 2-char element first, else 1-char
     ‚Ä¢ consume any trailing digits as stoichiometry
   Applied to every "word token" (starts with uppercase) in the free text.
   Each token is scored by the fraction of its characters that resolved to
   valid elements/digits. The highest-scoring token is returned as the formula,
   so "The name of the structure is CsPbBr3" ‚Üí "CsPbBr3". */
function extractFormulaFromText(txt){
  if(!txt) return '';

  // Exact element set from elementsEncoding.py (ordered list used as reference)
  const ELEMENTS = new Set([
    'H','He','Li','Be','B','C','N','O','F','Ne',
    'Na','Mg','Al','Si','P','S','Cl','Ar','K','Ca',
    'Sc','Ti','V','Cr','Mn','Fe','Co','Ni','Cu','Zn',
    'Ga','Ge','As','Se','Br','Kr','Rb','Sr','Y','Zr',
    'Nb','Mo','Tc','Ru','Rh','Pd','Ag','Cd','In','Sn',
    'Sb','Te','I','Xe','Cs','Ba','La','Ce','Pr','Nd',
    'Pm','Sm','Eu','Gd','Tb','Dy','Ho','Er','Tm','Yb',
    'Lu','Hf','Ta','W','Re','Os','Ir'
  ]);

  /* Parse a single string as a chemical formula using the same logic as
     elementsEncoding.py. Returns { formula, matchedChars }. */
  function tryParseFormula(s){
    let i = 0, formula = '', matched = 0;
    while(i < s.length){
      const ch = s[i];
      if(ch >= 'A' && ch <= 'Z'){
        // Try 2-char element first (Uppercase + lowercase), then 1-char
        let elem = (i+1 < s.length && s[i+1] >= 'a' && s[i+1] <= 'z')
                   ? s[i] + s[i+1] : s[i];
        if(elem.length === 2 && ELEMENTS.has(elem)){
          formula += elem; matched += 2; i += 2;
        } else if(ELEMENTS.has(s[i])){
          formula += s[i]; matched += 1; i += 1;
        } else {
          break; // unknown symbol, stop ‚Äî don't include garbage
        }
        // consume stoichiometric digits
        while(i < s.length && s[i] >= '0' && s[i] <= '9'){
          formula += s[i]; matched++; i++;
        }
      } else {
        break; // non-uppercase after a complete token ‚Üí stop
      }
    }
    return { formula, matched };
  }

  // Collect all word-tokens that start with an uppercase letter
  const candidates = txt.match(/[A-Z][A-Za-z0-9]*/g) || [];

  let bestFormula = '', bestScore = -1;
  for(const token of candidates){
    const parsed = tryParseFormula(token);
    if(!parsed.formula) continue;
    // Coverage: fraction of the token that resolved to valid element chars/digits
    const coverage = parsed.matched / token.length;
    // Heavily reward tokens that are 100% valid formula (no trailing junk)
    const score = coverage >= 1.0 ? 1000 + parsed.matched : parsed.matched * coverage;
    if(score > bestScore){ bestScore = score; bestFormula = parsed.formula; }
  }
  return bestFormula;
}

function renderMPResults(results, note){
  const resEl = document.getElementById('mpResults');
  if(!resEl) return;
  if(!results || results.length===0){
    resEl.innerHTML = `<div style="font-family:'Space Mono',monospace;font-size:11px;color:var(--text-dim);margin-top:4px;">No structures found</div>`;
    return;
  }
  let html = `<div style="display:flex;flex-direction:column;gap:6px;margin-top:6px;">`;
  if(note) html += `<div style="font-family:'Space Mono',monospace;font-size:9.9px;color:var(--text-dim);margin-bottom:2px;">${note}</div>`;
  for(const it of results){
    const sg  = it.symmetry?.symbol || it.spacegroup_symbol || '‚Äî';
    const a   = it.lattice_a != null ? it.lattice_a.toFixed(4) : (it.structure?._lattice?.a != null ? it.structure._lattice.a.toFixed(4) : '‚Äî');
    const nat = it.nsites || it.n_atoms || '‚Äî';
    const id  = it.material_id || it.mp_id || '';
    const fml = it.formula_pretty || it.formula || '';
    html += `<div onclick="selectMPResult('${id}','${fml}')" style="padding:8px 10px;border:1px solid var(--border);border-radius:6px;background:rgba(0,229,200,0.03);cursor:pointer;transition:border-color .15s;" onmouseover="this.style.borderColor='var(--accent2)'" onmouseout="this.style.borderColor='var(--border)'">`+
              `<div style="font-family:'Space Mono',monospace;font-size:11px;color:var(--accent2);margin-bottom:3px;">${id} ‚Äî ${fml}</div>`+
              `<div style="font-size:12px;color:var(--text);">${sg} ¬∑ a=${a} √Ö ¬∑ ${nat} atoms</div>`+
            `</div>`;
  }
  html += `</div>`;
  resEl.innerHTML = html;
}

// ====== CRYSTAL STRUCTURE VIEWER ======
const CPK_COLORS = {
  H:0xFFFFFF,He:0xD9FFFF,Li:0xCC80FF,Be:0xC2FF00,B:0xFFB5B5,C:0x909090,N:0x3050F8,O:0xFF0D0D,F:0x90E050,Ne:0xB3E3F5,
  Na:0xAB5CF2,Mg:0x8AFF00,Al:0xBFA6A6,Si:0xF0C8A0,P:0xFF8000,S:0xFFFF30,Cl:0x1FF01F,Ar:0x80D1E3,K:0x8F40D4,Ca:0x3DFF00,
  Sc:0xE6E6E6,Ti:0xBFC2C7,V:0xA6A6AB,Cr:0x8A99C7,Mn:0x9C7AC7,Fe:0xE06633,Co:0xF090A0,Ni:0x50D050,Cu:0xC88033,Zn:0x7D80B0,
  Ga:0xC28F8F,Ge:0x668F8F,As:0xBD80E3,Se:0xFFA100,Br:0xA62929,Kr:0x5CB8D1,Rb:0x702EB0,Sr:0x00FF00,Y:0x94FFFF,Zr:0x94E0E0,
  Nb:0x73C2C9,Mo:0x54B5B5,Tc:0x3B9E9E,Ru:0x248F8F,Rh:0x0A7D8C,Pd:0x006985,Ag:0xC0C0C0,Cd:0xFFD98F,In:0xA67573,Sn:0x668080,
  Sb:0x9E63B5,Te:0xD47A00,I:0x940094,Xe:0x429EB0,Cs:0x57178F,Ba:0x00C900,La:0x70D4FF,Ce:0xFFFFC7,Pr:0xD9FFC7,Nd:0xC7FFC7,Pb:0x575961,
  DEFAULT:0xFF69B4
};
const COVALENT_RADII = {
  H:0.31,He:0.28,Li:1.28,Be:0.96,B:0.84,C:0.76,N:0.71,O:0.66,F:0.57,Ne:0.58,
  Na:1.66,Mg:1.41,Al:1.21,Si:1.11,P:1.07,S:1.05,Cl:1.02,Ar:1.06,K:2.03,Ca:1.76,
  Sc:1.70,Ti:1.60,V:1.53,Cr:1.39,Mn:1.50,Fe:1.32,Co:1.26,Ni:1.24,Cu:1.32,Zn:1.22,
  Ga:1.22,Ge:1.20,As:1.19,Se:1.20,Br:1.20,Kr:1.16,Rb:2.20,Sr:1.95,Y:1.90,Zr:1.75,
  Nb:1.64,Mo:1.54,Tc:1.47,Ru:1.46,Rh:1.42,Pd:1.39,Ag:1.45,Cd:1.44,In:1.42,Sn:1.39,
  Sb:1.39,Te:1.38,I:1.39,Xe:1.40,Cs:2.44,Ba:2.15,La:2.07,Ce:2.04,Pb:1.46,
  DEFAULT:1.20
};
let crystalViewer = null;
let _structData = null;
function structFullscreen(){
  const vp=document.getElementById('structViewport');
  if(!vp) return;
  if(!document.fullscreenElement) vp.requestFullscreen&&vp.requestFullscreen();
  else document.exitFullscreen&&document.exitFullscreen();
}
function structToggleBonds(){
  if(!crystalViewer) return;
  crystalViewer._showBonds=!crystalViewer._showBonds;
  const btn=document.getElementById('btnBonds');
  if(btn) btn.classList.toggle('active',crystalViewer._showBonds);
  if(_structData) crystalViewer.load(_structData);
}
function structResetCamera(){
  if(crystalViewer) crystalViewer.resetCamera();
}
function structScreenshot(){
  if(!crystalViewer) return;
  crystalViewer.renderer.render(crystalViewer.scene, crystalViewer.camera);
  const url=crystalViewer.renderer.domElement.toDataURL('image/png');
  const a=document.createElement('a'); a.href=url; a.download='crystal_structure.png'; a.click();
}
function structExportJSON(){
  if(!_structData) return;
  const blob=new Blob([JSON.stringify(_structData,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=(_structData.material_id||'structure')+'.json'; a.click();
}
class CrystalViewer {
  constructor(container){
    this.container = container;
    this._showBonds = false;
    this._center = new THREE.Vector3();
    this._defaultCamPos = new THREE.Vector3();
    this.scene = new THREE.Scene();
    this.scene.background = new THREE.Color(0x070a0e);
    const w = container.clientWidth||600, h = container.clientHeight||400;
    this.camera = new THREE.PerspectiveCamera(45, w/h, 0.1, 1000);
    this.renderer = new THREE.WebGLRenderer({antialias:true, preserveDrawingBuffer:true});
    this.renderer.setPixelRatio(window.devicePixelRatio||1);
    this.renderer.setSize(w, h);
    this.renderer.domElement.className = 'struct-main-canvas';
    // Remove only a previous Three.js main canvas and empty-state, leave overlay children intact
    Array.from(container.children).forEach(el=>{
      if((el.tagName==='CANVAS' && el.id!=='axisCanvas') || el.id==='structEmpty' || el.id==='structLoadOverlay') el.remove();
    });
    container.insertBefore(this.renderer.domElement, container.firstChild);
    this._addLights();
    this.controls = new THREE.OrbitControls(this.camera, this.renderer.domElement);
    this.controls.enableDamping = true;
    this.controls.dampingFactor = 0.1;
    this.controls.rotateSpeed = 0.6;
    this._initAxisRenderer();
    this._animate();
    this._ro = new ResizeObserver(()=>this._onResize());
    this._ro.observe(container);
  }
  _initAxisRenderer(){
    const ac = document.getElementById('axisCanvas');
    if(!ac) return;
    ac.width = 100; ac.height = 100;
    ac.style.display='block';
    // Split: WebGL for arrows on a sub-canvas, 2D for labels on the same canvas
    // Use a dedicated off-screen canvas for WebGL so alpha compositing works
    this._axisGLCanvas = document.createElement('canvas');
    this._axisGLCanvas.width=100; this._axisGLCanvas.height=100;
    this._axisRenderer = new THREE.WebGLRenderer({canvas:this._axisGLCanvas, antialias:true, alpha:true});
    this._axisRenderer.setPixelRatio(1);
    this._axisRenderer.setSize(100,100);
    this._axisScene = new THREE.Scene();
    this._axisCamera = new THREE.PerspectiveCamera(50,1,0.1,100);
    this._axisCamera.position.set(0,0,2.5);
    const org=new THREE.Vector3();
    this._axisArrows=[
      new THREE.ArrowHelper(new THREE.Vector3(1,0,0),org,0.72,0xff3333,0.20,0.12),
      new THREE.ArrowHelper(new THREE.Vector3(0,1,0),org,0.72,0x22dd55,0.20,0.12),
      new THREE.ArrowHelper(new THREE.Vector3(0,0,1),org,0.72,0x3399ff,0.20,0.12),
    ];
    this._axisArrows.forEach(a=>this._axisScene.add(a));
    this._axisScene.add(new THREE.AmbientLight(0xffffff,1.2));
    this._axisCtx2d = ac.getContext('2d');
    this._axisLabelColors=['#ff4444','#33ee66','#4499ff'];
    this._axisLabelNames=['X','Y','Z'];
  }
  _addLights(){
    this.scene.add(new THREE.HemisphereLight(0xffffff,0x303030,0.8));
    const dl1=new THREE.DirectionalLight(0xffffff,0.9); dl1.position.set(5,8,5); this.scene.add(dl1);
    const dl2=new THREE.DirectionalLight(0x8888ff,0.4); dl2.position.set(-5,-3,-5); this.scene.add(dl2);
  }
  _animate(){
    this._raf = requestAnimationFrame(()=>this._animate());
    this.controls.update();
    this.renderer.render(this.scene, this.camera);
    if(this._axisRenderer && this._axisCamera){
      this._axisCamera.quaternion.copy(this.camera.quaternion);
      this._axisRenderer.render(this._axisScene, this._axisCamera);
      // Composite onto visible canvas + draw X/Y/Z labels
      if(this._axisCtx2d && this._axisGLCanvas){
        const ctx=this._axisCtx2d;
        ctx.clearRect(0,0,100,100);
        ctx.drawImage(this._axisGLCanvas,0,0);
        const cx=18, cy=82;
        ctx.fillStyle='rgba(10,12,16,0.85)';
        ctx.beginPath();
        ctx.arc(cx,cy,4,0,Math.PI*2);
        ctx.fill();
        // Project arrow tips to 2D
        const dirs=[new THREE.Vector3(1,0,0),new THREE.Vector3(0,1,0),new THREE.Vector3(0,0,1)];
        const proj=new THREE.Vector4();
        const mvp=new THREE.Matrix4().multiplyMatrices(this._axisCamera.projectionMatrix,this._axisCamera.matrixWorldInverse);
        dirs.forEach((d,i)=>{
          const tip=d.clone().multiplyScalar(0.9);
          proj.set(tip.x,tip.y,tip.z,1).applyMatrix4(mvp);
          const sx=(proj.x/proj.w*0.5+0.5)*100;
          const sy=(1-proj.y/proj.w*0.5-0.5)*100;
          const tx=Math.max(8,Math.min(92,sx));
          const ty=Math.max(8,Math.min(92,sy));
          // High-contrast 2D axis shaft + arrowhead (always visible)
          ctx.strokeStyle=this._axisLabelColors[i];
          ctx.lineWidth=3;
          ctx.beginPath();
          ctx.moveTo(cx,cy);
          ctx.lineTo(tx,ty);
          ctx.stroke();
          const ang=Math.atan2(ty-cy,tx-cx);
          const ah=6;
          ctx.fillStyle=this._axisLabelColors[i];
          ctx.beginPath();
          ctx.moveTo(tx,ty);
          ctx.lineTo(tx-ah*Math.cos(ang-Math.PI/7),ty-ah*Math.sin(ang-Math.PI/7));
          ctx.lineTo(tx-ah*Math.cos(ang+Math.PI/7),ty-ah*Math.sin(ang+Math.PI/7));
          ctx.closePath();
          ctx.fill();
          const lx=Math.max(6,Math.min(88,sx-5));
          const ly=Math.max(12,Math.min(96,sy+5));
          ctx.font='bold 13px Space Mono,monospace';
          ctx.fillStyle=this._axisLabelColors[i];
          ctx.strokeStyle='rgba(0,0,0,0.7)';
          ctx.lineWidth=3;
          ctx.strokeText(this._axisLabelNames[i],lx,ly);
          ctx.fillText(this._axisLabelNames[i],lx,ly);
        });
      }
    }
  }
  _onResize(){
    const w=this.container.clientWidth, h=this.container.clientHeight;
    if(w<10||h<10) return;
    this.camera.aspect=w/h;
    this.camera.updateProjectionMatrix();
    this.renderer.setSize(w,h);
  }
  clear(){
    while(this.scene.children.length){ const o=this.scene.children[0]; if(o.geometry)o.geometry.dispose(); if(o.material)o.material.dispose(); this.scene.remove(o); }
    this._addLights();
  }
  load(data){
    this.clear();
    const mat = data.lattice.matrix;
    const va=new THREE.Vector3(mat[0][0],mat[0][1],mat[0][2]);
    const vb=new THREE.Vector3(mat[1][0],mat[1][1],mat[1][2]);
    const vc=new THREE.Vector3(mat[2][0],mat[2][1],mat[2][2]);
    const o=new THREE.Vector3(0,0,0);
    const corners=[o.clone(),va.clone(),vb.clone(),vc.clone(),va.clone().add(vb),va.clone().add(vc),vb.clone().add(vc),va.clone().add(vb).add(vc)];
    const edges=[[0,1],[0,2],[0,3],[1,4],[1,5],[2,4],[2,6],[3,5],[3,6],[4,7],[5,7],[6,7]];
    const pts=[]; for(const [i,j] of edges){pts.push(corners[i]);pts.push(corners[j]);}
    const cg=new THREE.BufferGeometry().setFromPoints(pts);
    this.scene.add(new THREE.LineSegments(cg,new THREE.LineBasicMaterial({color:0x3d7eff,opacity:0.75,transparent:true})));
    const geomCache={};
    const elemSet=new Set();
    for(const site of data.sites){
      const elem=site.species?.[0]?.element||'X';
      elemSet.add(elem);
      const color=CPK_COLORS[elem]||CPK_COLORS.DEFAULT;
      const radius=(COVALENT_RADII[elem]||COVALENT_RADII.DEFAULT)*0.4;
      if(!geomCache[elem]) geomCache[elem]=new THREE.SphereGeometry(radius,20,20);
      const mesh=new THREE.Mesh(geomCache[elem], new THREE.MeshPhongMaterial({color,shininess:80,specular:new THREE.Color(0.3,0.3,0.3)}));
      const [x,y,z]=site.xyz; mesh.position.set(x,y,z);
      this.scene.add(mesh);
    }
    if(this._showBonds) this._addBonds(data.sites);
    const center=va.clone().add(vb).add(vc).multiplyScalar(0.5);
    const maxDim=Math.max(va.length(),vb.length(),vc.length());
    this._center.copy(center);
    this._defaultCamPos.copy(center.clone().add(new THREE.Vector3(maxDim*1.5,maxDim*1.0,maxDim*1.5)));
    this.camera.position.copy(this._defaultCamPos);
    this.controls.target.copy(center);
    this.controls.update();
    return [...elemSet];
  }
  _addBonds(sites){
    const bondMat=new THREE.MeshPhongMaterial({color:0x888899,shininess:40});
    for(let i=0;i<sites.length;i++){
      const pi=new THREE.Vector3(...sites[i].xyz);
      const ri=(COVALENT_RADII[sites[i].species?.[0]?.element]||1.2)*0.4;
      for(let j=i+1;j<sites.length;j++){
        const pj=new THREE.Vector3(...sites[j].xyz);
        const rj=(COVALENT_RADII[sites[j].species?.[0]?.element]||1.2)*0.4;
        const dist=pi.distanceTo(pj);
        if(dist<(ri+rj)*2.2 && dist>0.4){
          const mid=pi.clone().add(pj).multiplyScalar(0.5);
          const dir=pj.clone().sub(pi).normalize();
          const cyl=new THREE.CylinderGeometry(0.05,0.05,dist,8,1);
          const mesh=new THREE.Mesh(cyl,bondMat);
          mesh.position.copy(mid);
          mesh.quaternion.setFromUnitVectors(new THREE.Vector3(0,1,0),dir);
          this.scene.add(mesh);
        }
      }
    }
  }
  resetCamera(){
    if(this._defaultCamPos.length()===0) return;
    this.camera.position.copy(this._defaultCamPos);
    this.controls.target.copy(this._center);
    this.controls.update();
  }
  // Rebuild scene but keep camera exactly where it is
  loadSites(data){
    // Save camera before clear()
    const camPos = this.camera.position.clone();
    const tgt    = this.controls.target.clone();
    this.clear();
    // Rebuild lattice box
    const mat=data.lattice.matrix;
    const va=new THREE.Vector3(mat[0][0],mat[0][1],mat[0][2]);
    const vb=new THREE.Vector3(mat[1][0],mat[1][1],mat[1][2]);
    const vc=new THREE.Vector3(mat[2][0],mat[2][1],mat[2][2]);
    const o=new THREE.Vector3();
    const corners=[o.clone(),va.clone(),vb.clone(),vc.clone(),
                   va.clone().add(vb),va.clone().add(vc),
                   vb.clone().add(vc),va.clone().add(vb).add(vc)];
    const edges=[[0,1],[0,2],[0,3],[1,4],[1,5],[2,4],[2,6],[3,5],[3,6],[4,7],[5,7],[6,7]];
    const pts=[]; for(const[i,j]of edges){pts.push(corners[i]);pts.push(corners[j]);}
    this.scene.add(new THREE.LineSegments(
      new THREE.BufferGeometry().setFromPoints(pts),
      new THREE.LineBasicMaterial({color:0x3d7eff,opacity:0.75,transparent:true})));
    // Add atoms ‚Äî fresh geometry per mesh to avoid shared-dispose bug
    const elemSet=new Set();
    for(const site of data.sites){
      const elem=site.species?.[0]?.element||'X';
      elemSet.add(elem);
      const color=(CPK_COLORS[elem]||CPK_COLORS.DEFAULT);
      const radius=(COVALENT_RADII[elem]||COVALENT_RADII.DEFAULT)*0.4;
      const mesh=new THREE.Mesh(
        new THREE.SphereGeometry(radius,14,14),
        new THREE.MeshPhongMaterial({color,shininess:80}));
      const[x,y,z]=site.xyz; mesh.position.set(x,y,z);
      this.scene.add(mesh);
    }
    // Restore camera ‚Äî no jump
    this.camera.position.copy(camPos);
    this.controls.target.copy(tgt);
    this.controls.update();
    return[...elemSet];
  }
  dispose(){ this._ro.disconnect(); cancelAnimationFrame(this._raf); this.renderer.dispose(); if(this._axisRenderer){this._axisRenderer.dispose();} }
}

async function loadStructure(mpId, formula){
  const viewport=document.getElementById('structViewport');
  const badge=document.getElementById('structBadge');
  const summary=document.getElementById('structSummary');
  if(!viewport) return;
  // Show loading overlay without wiping overlay DOM children (controls, legend, axisCanvas)
  let loadOverlay = document.getElementById('structLoadOverlay');
  if(!loadOverlay){
    loadOverlay = document.createElement('div');
    loadOverlay.id='structLoadOverlay';
    loadOverlay.style.cssText='position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-family:Space Mono,monospace;font-size:12px;color:var(--text-dim);background:#070a0e;z-index:2;';
    viewport.appendChild(loadOverlay);
  }
  loadOverlay.textContent=`Loading ${mpId}\u2026`;
  loadOverlay.style.display='flex';
  const emptyEl=document.getElementById('structEmpty');
  if(emptyEl) emptyEl.style.display='none';
  if(badge){badge.textContent=mpId;badge.className='panel-badge active';}
  if(summary) summary.innerHTML=`<div style="font-family:'Space Mono',monospace;font-size:11px;color:var(--text-dim);text-align:center;padding-top:20px;">Fetching structural data‚Ä¶</div>`;
  try{
    const r=await fetch(`/api/mp_structure/${mpId}`);
    if(!r.ok) throw new Error('HTTP '+r.status);
    const data=await r.json();
    if(data.error) throw new Error(data.error);
    // Remove loading overlay, leave controls/legend/axisCanvas intact
    const lo=document.getElementById('structLoadOverlay');
    if(lo) lo.remove();
    viewport.style.background='#070a0e';
    if(crystalViewer){try{crystalViewer.dispose();}catch(e){}}
    crystalViewer=new CrystalViewer(viewport);
    const elems=crystalViewer.load(data);
    // Show controls & axis
    const ctrl=document.getElementById('structControls');
    if(ctrl) ctrl.style.display='flex';
    const ac=document.getElementById('axisCanvas');
    if(ac) ac.style.display='block';
    // Build element legend
    const leg=document.getElementById('structLegend');
    if(leg && elems){
      leg.style.display='flex';
      leg.innerHTML=elems.map(el=>{
        const c=CPK_COLORS[el]||CPK_COLORS.DEFAULT;
        const hex='#'+c.toString(16).padStart(6,'0');
        return `<div class="leg-pill"><div class="leg-dot" style="background:${hex};"></div><span class="leg-label">${el}</span></div>`;
      }).join('');
    }
    const lat=data.lattice||{};
    const sym=data.symmetry||{};
    const a=(lat.a||0).toFixed(4),b=(lat.b||0).toFixed(4),c=(lat.c||0).toFixed(4);
    const al=(lat.alpha||0).toFixed(2),be=(lat.beta||0).toFixed(2),ga=(lat.gamma||0).toFixed(2);
    const vol=(lat.volume||0).toFixed(2);
    const nsites=data.nsites||(data.sites&&data.sites.length)||'‚Äî';
    if(summary) summary.innerHTML=`
      <div style="font-family:'Space Mono',monospace;font-size:9.9px;color:var(--accent2);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;">${data.formula||formula} ¬∑ ${sym.symbol||sym.crystal_system||''}</div>
      <div class="lat-grid">
        <div class="lat-item"><div class="lat-key">a (√Ö)</div><div class="lat-val">${a}</div></div>
        <div class="lat-item"><div class="lat-key">b (√Ö)</div><div class="lat-val">${b}</div></div>
        <div class="lat-item"><div class="lat-key">c (√Ö)</div><div class="lat-val">${c}</div></div>
        <div class="lat-item"><div class="lat-key">Œ± (¬∞)</div><div class="lat-val">${al}</div></div>
        <div class="lat-item"><div class="lat-key">Œ≤ (¬∞)</div><div class="lat-val">${be}</div></div>
        <div class="lat-item"><div class="lat-key">Œ≥ (¬∞)</div><div class="lat-val">${ga}</div></div>
        <div class="lat-item"><div class="lat-key">Vol (√Ö¬≥)</div><div class="lat-val">${vol}</div></div>
        <div class="lat-item"><div class="lat-key">Sites</div><div class="lat-val">${nsites}</div></div>
      </div>`;
  }catch(e){
    viewport.innerHTML=`<div style="display:flex;align-items:center;justify-content:center;height:100%;font-family:'Space Mono',monospace;font-size:12px;color:var(--warn);position:absolute;inset:0;background:#070a0e;z-index:2;">Error: ${e.message}</div>`;
    const lo2=document.getElementById('structLoadOverlay'); if(lo2) lo2.remove();
    if(summary) summary.innerHTML='';
    if(badge){badge.textContent='ERROR';badge.className='panel-badge';}
  }
}
// ====== END CRYSTAL VIEWER ======

function selectMPResult(mpId, formula){
  // clicking a result prefills domain textarea and updates currentSample
  const dk = document.getElementById('dkInput');
  if(dk && !dk.value.trim()) dk.value = formula;
  currentSample = {name: formula, ce: currentSample.ce||0};
  const resEl = document.getElementById('mpResults');
  if(resEl){
    resEl.querySelectorAll('div[onclick]').forEach(el=>{
      el.style.borderColor='var(--border)';
      el.style.background='rgba(0,229,200,0.03)';
    });
  }
  addMsg('agent','ATOMINFER AGENT','ü§ñ',`MP structure selected: <strong>${mpId}</strong> ‚Äî ${formula}`);
  loadStructure(mpId, formula);
}

async function mpSearchFormula(formula){
  const resEl = document.getElementById('mpResults');
  if(!resEl) return;
  resEl.innerHTML = `<div style="font-family:'Space Mono',monospace;font-size:11px;color:var(--text-dim);margin-top:4px;">Searching Materials Project‚Ä¶</div>`;
  try{
    // Route through backend so CORS is never an issue
    const r = await fetch('/api/mp_search', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({formula})
    });
    if(!r.ok){
      resEl.innerHTML = `<div style="font-family:'Space Mono',monospace;font-size:11px;color:var(--warn);">Backend error ${r.status} ‚Äî is the server running?</div>`;
      return;
    }
    const data = await r.json();
    if(data.error){ resEl.innerHTML = `<div style="font-family:'Space Mono',monospace;font-size:11px;color:var(--warn);">MP error: ${data.error}</div>`; return; }
    const results = data.results || [];
    renderMPResults(results, data.note);
  }catch(e){
    resEl.innerHTML = `<div style="font-family:'Space Mono',monospace;font-size:11px;color:var(--warn);">Could not reach backend ‚Äî open via <strong>http://localhost:8000</strong></div>`;
    console.error('MP search error:', e);
  }
}

const _onDKInput = debounce(function(e){
  const txt = (e.target.value||'').trim();
  const formula = extractFormulaFromText(txt);
  if(!formula){ document.getElementById('mpResults').innerHTML=''; return; }
  if(formula === _lastQueriedFormula) return;
  _lastQueriedFormula = formula;
  mpSearchFormula(formula);
}, 500);

const dk = document.getElementById('dkInput');
if(dk){
  dk.addEventListener('input', _onDKInput);
  // clear search panel when textarea is cleared
  dk.addEventListener('blur', function(){
    if(!this.value.trim() && document.getElementById('mpResults')){
      _lastQueriedFormula = '';
    }
  });
}

async function startAnalysis(){
  if(running)return;
  running=true;
  document.getElementById('runBtn').disabled=true;
  document.getElementById('logContainer').innerHTML='';
  const sN=currentSample.name;
  let data=SAMPLE_DATA[sN];
  if(!data){
    const base=SAMPLE_DATA['LMO']||SAMPLE_DATA['1% Ce-doped'];
    data=Object.assign({}, base);
    data.ce = Number.isFinite(currentSample.ce)?currentSample.ce:base.ce;
    // approximate Ce substitutions from Ce% relative to Mn count
    data.n_ce = Math.max(0, Math.round(base.n_mn*(data.ce/100)));
    data.n_mn = base.n_mn - data.n_ce;
  }

  await addMsg('user','USER REQUEST','üë§',`Analyze XRD file <strong>XRD_Data_-_Nikhil.xlsx</strong>, sheet "<strong>${sN}</strong>". Identify phase, extract lattice parameter and crystallite size, query Materials Project, build Ce-doped atomistic model, validate with R-factor.`);
  await sleep(600);

  advanceStep(0);addTyping();await sleep(1200);removeTyping();
  await addMsg('agent','ATOMINFER AGENT','ü§ñ',`I'll begin by parsing the XRD file. The sheet "${sN}" should contain Rigaku-format data with columns: Angle, I(o), I(b). Net intensity = I(o) ‚àí I(b). Expecting ~1600 data points between 5‚Äì70¬∞ 2Œ∏ for Cu KŒ± (Œª = 1.54059 √Ö).`);
  await addToolCall('parse_xrd_file',`filepath = "XRD_Data_-_Nikhil.xlsx"\nsheet_name = "${sN}"`,300);
  await sleep(800);
  await addToolResult(`<div class="kv-grid"><span class="kv-key">status</span><span class="kv-val highlight">success</span><span class="kv-key">n_points</span><span class="kv-val">1,622</span><span class="kv-key">range</span><span class="kv-val">5.00 ‚Äì 69.97¬∞</span><span class="kv-key">wavelength</span><span class="kv-val">1.54059 √Ö (Cu KŒ±)</span><span class="kv-key">instrument</span><span class="kv-val">Rigaku ¬∑ 45kV/40mA</span></div>`,200);

  advanceStep(1);addTyping();await sleep(1000);removeTyping();
  await addMsg('agent','ATOMINFER AGENT','ü§ñ',`Data parsed successfully. Now assigning hkl indices using LiMn‚ÇÇO‚ÇÑ Fd-3ÃÑm reflection rules. Expecting peaks at: (111)‚âà18.9¬∞, (311)‚âà36.5¬∞, (400)‚âà44.4¬∞, (511)‚âà58.8¬∞, (440)‚âà64.5¬∞. Applying Nelson-Riley extrapolation + Scherrer equation from (111) FWHM.`);
  await addToolCall('analyze_xrd_peaks',`two_theta = [array, 1622 pts]\nintensity  = [array, 1622 pts]\nwavelength_A = 1.54059`,300);
  await sleep(1100);
  const a=data.lattice,D=data.size,deltaA=(a-8.2480).toFixed(4);
  await addToolResult(`<div class="kv-grid"><span class="kv-key">phase</span><span class="kv-val highlight">LiMn‚ÇÇO‚ÇÑ spinel (Fd-3ÃÑm)</span><span class="kv-key">peaks found</span><span class="kv-val">6/6 expected</span><span class="kv-key">lattice_a</span><span class="kv-val highlight">${a.toFixed(4)} √Ö</span><span class="kv-key">NR quality</span><span class="kv-val">good (6 peaks)</span><span class="kv-key">Œîa vs ICDD</span><span class="kv-val warn">${deltaA} √Ö</span><span class="kv-key">crystallite D</span><span class="kv-val highlight">${D.toFixed(1)} nm</span><span class="kv-key">CeO‚ÇÇ phase</span><span class="kv-val">not detected</span></div>`,200);

  showResultsPanel();updateMetrics(data);

  advanceStep(2);addTyping();await sleep(800);removeTyping();
  const note=data.ce===0.5?`Lattice contraction at 0.5% Ce (${a.toFixed(4)} √Ö) vs pristine 8.1688 √Ö. Suggests Ce‚Å¥‚Å∫ (r=0.87 √Ö) dominates at low doping ‚Äî smaller than Mn¬≥‚Å∫, causing compression. Physically meaningful.`:data.ce===2.0?`Lattice expansion to ${a.toFixed(4)} √Ö at 2% Ce confirms Ce¬≥‚Å∫ (r=1.01 √Ö) dominance. Non-monotonic trend 8.1688‚Üí8.1277‚Üí8.1637‚Üí8.1909 √Ö across series is a key scientific finding: Ce¬≥‚Å∫/Ce‚Å¥‚Å∫ mixed valence crossover.`:data.ce===1.0?`Lattice recovery at 1% (${a.toFixed(4)} √Ö) consistent with mixed Ce¬≥‚Å∫/Ce‚Å¥‚Å∫ valence crossover. The non-monotonic behavior across the series is physically meaningful.`:`Reference sample. Lattice ${a.toFixed(4)} √Ö, single phase. Systematic offset ‚àí${Math.abs(deltaA)} √Ö from ICDD consistent with nanoparticle synthesis.`;
  await addMsg('agent','ATOMINFER AGENT','ü§ñ',note);

  advanceStep(3);await sleep(400);advanceStep(4);addTyping();await sleep(1300);removeTyping();
  await addMsg('agent','ATOMINFER AGENT','ü§ñ',`Phase confirmed: single-phase spinel. Querying Materials Project for base structure. Using <strong>mp-19017</strong> (LiMn‚ÇÇO‚ÇÑ, Fd-3ÃÑm, conventional unit cell). MP lattice = reference only ‚Äî I'll scale to measured ${a.toFixed(4)} √Ö.`);
  await addToolCall('query_materials_project',`formula = "LiMn2O4"\nmp_id   = "mp-19017"\n# fetching conventional unit cell`,300);
  await sleep(1200);
  await addToolResult(`<div class="kv-grid"><span class="kv-key">mp_id</span><span class="kv-val highlight">mp-19017</span><span class="kv-key">formula</span><span class="kv-val">LiMn‚ÇÇO‚ÇÑ</span><span class="kv-key">space_group</span><span class="kv-val">Fd-3ÃÑm (#227)</span><span class="kv-key">lattice_a_MP</span><span class="kv-val">8.3120 √Ö</span><span class="kv-key">n_atoms</span><span class="kv-val">56 (unit cell)</span><span class="kv-key">species</span><span class="kv-val">Li:8, Mn:16, O:32</span><span class="kv-key">cif_saved</span><span class="kv-val">./base_mp-19017.cif</span></div>`,200);

  advanceStep(5);addTyping();await sleep(1000);removeTyping();
  const scN=data.size>60?3:2;
  await addMsg('agent','ATOMINFER AGENT','ü§ñ',`Base structure retrieved. Building ${scN}√ó${scN}√ó${scN} supercell. Scaling lattice: 8.3120 √Ö (MP) ‚Üí ${a.toFixed(4)} √Ö (measured). Ce fraction: ${data.ce}% ‚Üí ${data.n_ce} Mn‚ÜíCe substitution(s) at 16d sites. Random seed=42 for reproducibility.`);
  await addToolCall('build_doped_supercell',`base_cif_path      = "./base_mp-19017.cif"\nmeasured_lattice_a = ${a.toFixed(4)}\nCe_fraction        = ${(data.ce/100).toFixed(4)}\ncrystallite_size_nm= ${D.toFixed(1)}`,300);
  await sleep(1400);
  const total=data.n_li+data.n_mn+data.n_ce+data.n_o;
  const lbl=`LMO_Ce${data.ce}pct_${scN}x${scN}x${scN}`;
  await addToolResult(`<div class="kv-grid"><span class="kv-key">status</span><span class="kv-val highlight">success</span><span class="kv-key">supercell</span><span class="kv-val">${scN}√ó${scN}√ó${scN}</span><span class="kv-key">n_atoms</span><span class="kv-val highlight">${total}</span><span class="kv-key">Li/Mn/Ce/O</span><span class="kv-val">${data.n_li}/${data.n_mn}/${data.n_ce}/${data.n_o}</span><span class="kv-key">actual Ce%</span><span class="kv-val">${data.ce.toFixed(2)}%</span><span class="kv-key">output_cif</span><span class="kv-val">${lbl}.cif</span><span class="kv-key">output_vasp</span><span class="kv-val">${lbl}.vasp</span></div>`,200);

  advanceStep(6);addTyping();await sleep(900);removeTyping();
  await addMsg('agent','ATOMINFER AGENT','ü§ñ',`Supercell built. Computing XRD R-factor to validate simulated pattern against experiment using pymatgen XRDCalculator (Cu KŒ±).`);
  await addToolCall('compute_xrd_r_factor',`structure_path = "${lbl}.cif"\ntwo_theta_exp  = [array, 1622 pts]\nintensity_exp  = [array, 1622 pts]`,300);
  await sleep(1200);
  const R=0.12+data.ce*0.018+(Math.random()-0.5)*0.02;
  const Rpct=(R*100).toFixed(1);
  const qstr=R<0.15?'good ‚Äî consistent with experiment':R<0.25?'acceptable for initial MD model':'fair ‚Äî HRMC refinement recommended';
  await addToolResult(`<div class="kv-grid"><span class="kv-key">R_factor</span><span class="kv-val highlight">${Rpct}%</span><span class="kv-key">quality</span><span class="kv-val good">${qstr}</span></div>`,200);
  updateRFactor(R);drawXRDChart(data.ce);

  advanceStep(7);addTyping();await sleep(1000);removeTyping();
  for(let i=0;i<8;i++){const s=document.getElementById('step'+i);s.classList.add('done');s.classList.remove('active');}
  document.getElementById('progressLabelLeft').textContent='‚úì Complete';
  document.getElementById('progressLabelRight').innerHTML=`<span>8</span>/8`;
  document.getElementById('iterBadge').textContent='COMPLETE';

  await addMsg('agent','ATOMINFER AGENT','ü§ñ',
    `<strong>Analysis complete.</strong><br><br>üìã <strong>Summary for ${sN}:</strong><br>`+
    `‚Ä¢ Phase: LiMn‚ÇÇO‚ÇÑ spinel (Fd-3ÃÑm), single phase<br>`+
    `‚Ä¢ Lattice a = ${a.toFixed(4)} √Ö (Œî = ${deltaA} √Ö vs ICDD 8.2480 √Ö)<br>`+
    `‚Ä¢ Crystallite D = ${D.toFixed(0)} nm (Scherrer from (111))<br>`+
    `‚Ä¢ Ce fraction: ${data.ce}% substituted at Mn 16d sites<br>`+
    `‚Ä¢ Supercell: ${scN}√ó${scN}√ó${scN}, ${total} atoms<br>`+
    `‚Ä¢ R-factor: ${Rpct}% ‚Äî ${qstr}<br>`+
    `‚Ä¢ Files: <strong>${lbl}.cif</strong> and <strong>${lbl}.vasp</strong><br><br>`+
    `Structure is ready for LAMMPS/VASP molecular dynamics.`);

  if(data.ce>0){
    const sciEl=document.getElementById('scienceNote');sciEl.style.display='block';
    const txt=data.ce===0.5?`Lattice contraction at 0.5% Ce (${a.toFixed(4)} √Ö) vs pristine 8.1688 √Ö suggests Ce‚Å¥‚Å∫ charge state (r=0.87 √Ö) dominates at low doping.`:data.ce===2.0?`Non-monotonic trend across series (8.1688‚Üí8.1277‚Üí8.1637‚Üí8.1909 √Ö) confirms Ce¬≥‚Å∫/Ce‚Å¥‚Å∫ mixed valence crossover. At 2% Ce, Ce¬≥‚Å∫ (r=1.01 √Ö) dominates ‚Üí lattice expansion ‚Üí reduced Jahn-Teller distortion.`:`Partial lattice recovery at 1% Ce consistent with mixed Ce¬≥‚Å∫/Ce‚Å¥‚Å∫ valence transition.`;
    document.getElementById('scienceNoteText').innerHTML=txt;
  }
  running=false;
  document.getElementById('runBtn').disabled=false;
  document.getElementById('runBtn').textContent='‚Ü∫ RUN AGAIN';
}

// Draw real XRD pattern from HRMC frame data
function drawHRMCXRDChart(x, simY, expY){
  const canvas = document.getElementById('xrdChart');
  if(!canvas) return;
  const dpr = window.devicePixelRatio||1;
  canvas.width  = canvas.offsetWidth  * dpr;
  canvas.height = canvas.offsetHeight * dpr;
  const ctx = canvas.getContext('2d');
  ctx.scale(dpr, dpr);
  const W = canvas.offsetWidth, H = canvas.offsetHeight;
  ctx.clearRect(0,0,W,H);
  if(!x || !simY || !expY || x.length === 0) return;
  const xMin = x[0], xRange = x[x.length-1] - x[0];
  const maxVal = Math.max(...simY, ...expY, 1);
  function drawLine(yArr, color, lw){
    ctx.beginPath(); ctx.strokeStyle = color; ctx.lineWidth = lw;
    for(let i=0;i<x.length;i++){
      const px = ((x[i]-xMin)/xRange)*W;
      const py = H-4-(yArr[i]/maxVal)*(H-8);
      i===0 ? ctx.moveTo(px,py) : ctx.lineTo(px,py);
    }
    ctx.stroke();
  }
  drawLine(expY, 'rgba(247,183,49,0.65)', 1.5);  // yellow: target
  drawLine(simY, 'rgba(61,126,255,0.9)',  1.5);   // blue: simulated
}

// ====== HRMC ‚Äî PNG TRAJECTORY SLIDESHOW (primary) + WS live (commented backup) ======
let hrmcWs = null;
let hrmcRunning = false;

async function runHRMC() {
  if (hrmcRunning) return;
  hrmcRunning = true;

  const btn = document.getElementById('hrmcBtn');
  btn.disabled = true;
  btn.textContent = '‚è≥ GENERATING...';

  const ce_pct = parseFloat(document.getElementById('hrmcCePct').value) || 5.0;
  const n_steps = parseInt(document.getElementById('hrmcSteps').value) || 50;

  // Load and display initial CIF structure in viewer
  try {
    const r = await fetch('/api/cif_structure?path=./LiMn2O4.cif');
    const data = await r.json();
    if (data.error) throw new Error(data.error);
    const viewport = document.getElementById('structViewport');
    const emptyEl = document.getElementById('structEmpty');
    if (emptyEl) emptyEl.style.display = 'none';
    const lo = document.getElementById('structLoadOverlay');
    if (lo) lo.remove();
    if (crystalViewer) { try { crystalViewer.dispose(); } catch(e) {} }
    crystalViewer = new CrystalViewer(viewport);
    _structData = data;
    const elems = crystalViewer.load(data);
    const ctrl = document.getElementById('structControls');
    if (ctrl) ctrl.style.display = 'flex';
    const ac = document.getElementById('axisCanvas');
    if (ac) ac.style.display = 'block';
    const leg = document.getElementById('structLegend');
    if (leg && elems) {
      leg.style.display = 'flex';
      leg.innerHTML = elems.map(el => {
        const c = CPK_COLORS[el] || CPK_COLORS.DEFAULT;
        const hex = '#' + c.toString(16).padStart(6, '0');
        return `<div class="leg-pill"><div class="leg-dot" style="background:${hex};"></div><span class="leg-label">${el}</span></div>`;
      }).join('');
    }
    const badge = document.getElementById('structBadge');
    if (badge) { badge.textContent = 'LiMn2O4'; badge.className = 'panel-badge active'; }
  } catch(e) {
    btn.disabled = false;
    btn.textContent = '‚ö° REFINE STRUCTURE';
    hrmcRunning = false;
    addMsg('agent', 'ATOMINFER AGENT', 'ü§ñ', `Error loading CIF: ${e.message}`);
    return;
  }

  // ‚îÄ‚îÄ HARDCODED FRAME SLIDESHOW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  btn.textContent = '‚è≥ GENERATING FRAMES...';
  addMsg('agent','ATOMINFER AGENT','ü§ñ',
    `Running HRMC trajectory ‚Äî Ce ${ce_pct}%, generating ${Math.round(n_steps/20)+4} frames‚Ä¶`);
  try {
    const fr = await fetch('/api/hrmc/frames', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({cif_path:'./LiMn2O4.cif', ce_pct,
                            n_frames: Math.min(Math.round(n_steps/20)+4, 8)})
    });
    const {frames, error} = await fr.json();
    if(error) throw new Error(error);
    // Show slideshow overlay
    const slideshow = document.getElementById('hrmcSlideshow');
    const frameImg  = document.getElementById('hrmcFrameImg');
    const frameLbl  = document.getElementById('hrmcFrameLabel');
    slideshow.style.display = 'flex';
    let fi = 0;
    // Pre-load all frames then animate
    const loaded = await Promise.all(frames.map(src => new Promise(res=>{
      const img = new Image(); img.onload=()=>res(src); img.onerror=()=>res(src);
      img.src = src+'?t='+Date.now();
    })));
    frameImg.src = loaded[0]+'?t='+Date.now();
    frameLbl.textContent = `Frame 1 / ${loaded.length}`;
    btn.textContent = `‚è≥ FRAME 1/${loaded.length}`;
    const iv = setInterval(()=>{
      fi++;
      if(fi >= loaded.length){
        clearInterval(iv);
        setTimeout(()=>{ slideshow.style.display='none'; },1500);
        btn.disabled = false;
        btn.textContent = '‚ö° REFINE AGAIN';
        hrmcRunning = false;
        addMsg('agent','ATOMINFER AGENT','ü§ñ',
          `<strong>HRMC trajectory complete.</strong> Ce ${ce_pct}% ‚Äî structure evolved over ${loaded.length} frames. Atoms shuffled, Ce substituted at Mn 16d sites.`);
        return;
      }
      frameImg.src = loaded[fi]+'?t='+Date.now();
      frameLbl.textContent = `Frame ${fi+1} / ${loaded.length}`;
      btn.textContent = `‚è≥ FRAME ${fi+1}/${loaded.length}`;
    }, 1100);
    return; // done ‚Äî skip WebSocket path below
  } catch(e) {
    addMsg('agent','ATOMINFER AGENT','ü§ñ',`Frame gen error: ${e.message} ‚Äî falling back to live stream`);
  }
  // ‚îÄ‚îÄ END SLIDESHOW ‚Äî fall through to WebSocket live stream if frames fail ‚îÄ‚îÄ‚îÄ

  btn.textContent = '‚è≥ STARTING HRMC...';
  addMsg('agent', 'ATOMINFER AGENT', 'ü§ñ',
    `Starting HRMC refinement ‚Äî Ce ${ce_pct}%, ${n_steps} steps on LiMn‚ÇÇO‚ÇÑ structure.`);

  let runId;
  try {
    const resp = await fetch('/api/hrmc/start', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({cif_path: './LiMn2O4.cif', ce_pct, n_steps})
    });
    const j = await resp.json();
    if (j.error) throw new Error(j.error);
    runId = j.run_id;
  } catch(e) {
    btn.disabled = false;
    btn.textContent = '‚ö° REFINE STRUCTURE';
    hrmcRunning = false;
    addMsg('agent', 'ATOMINFER AGENT', 'ü§ñ', `HRMC start error: ${e.message}`);
    return;
  }

  // Show HRMC stats overlay
  const overlay = document.getElementById('hrmcOverlay');
  if (overlay) overlay.style.display = 'flex';
  btn.textContent = '‚è≥ RUNNING HRMC...';

  // Open WebSocket stream
  const wsProto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  const ws = new WebSocket(`${wsProto}//${location.host}/api/hrmc/${runId}/stream`);
  hrmcWs = ws;

  ws.onmessage = (event) => {
    const msg = JSON.parse(event.data);
    if (msg.type === 'status') {
      btn.textContent = `‚è≥ ${msg.message.slice(0, 30)}`;

    } else if (msg.type === 'frame') {
      // Full frame: update 3D viewer (loadSites preserves camera angle)
      if (msg.structure && crystalViewer) {
        _structData = msg.structure;
        const elems = crystalViewer.loadSites(msg.structure);
        // Sync element legend
        const leg = document.getElementById('structLegend');
        if (leg && elems) {
          leg.innerHTML = elems.map(el => {
            const c = CPK_COLORS[el]||CPK_COLORS.DEFAULT;
            const hex = '#'+c.toString(16).padStart(6,'0');
            return `<div class="leg-pill"><div class="leg-dot" style="background:${hex};"></div><span class="leg-label">${el}</span></div>`;
          }).join('');
        }
      }
      // Real XRD chart
      if (msg.pattern) {
        drawHRMCXRDChart(msg.pattern.x, msg.pattern.sim_y, msg.pattern.exp_y);
      }
      // Update stats (every frame)
      const cost = msg.cost || {};
      const pct = Math.round((msg.step / msg.n_steps) * 100);
      document.getElementById('hrmcStep').textContent = `Step ${msg.step}/${msg.n_steps} (${pct}%)`;
      document.getElementById('hrmcRfactor').textContent = `R: ${((cost.R_factor||0)*100).toFixed(1)}%`;
      document.getElementById('hrmcEnergy').textContent = `E/atom: ${(cost.E_per_atom||0).toFixed(3)} eV`;
      document.getElementById('hrmcXce').textContent = `Ce: ${((cost.x_Ce||0)*100).toFixed(1)}%`;
      if (cost.R_factor != null) updateRFactor(cost.R_factor);
      btn.textContent = `‚è≥ STEP ${msg.step}/${msg.n_steps}`;

    } else if (msg.type === 'progress') {
      // Lightweight tick ‚Äî just update step counter and stats
      const cost = msg.cost || {};
      const pct = Math.round((msg.step / msg.n_steps) * 100);
      document.getElementById('hrmcStep').textContent = `Step ${msg.step}/${msg.n_steps} (${pct}%)`;
      document.getElementById('hrmcRfactor').textContent = `R: ${((cost.R_factor||0)*100).toFixed(1)}%`;
      document.getElementById('hrmcEnergy').textContent = `E/atom: ${(cost.E_per_atom||0).toFixed(3)} eV`;
      document.getElementById('hrmcXce').textContent = `Ce: ${((cost.x_Ce||0)*100).toFixed(1)}%`;
      btn.textContent = `‚è≥ STEP ${msg.step}/${msg.n_steps}`;

    } else if (msg.type === 'done') {
      const fc = msg.final_cost || {};
      if (overlay) setTimeout(() => { overlay.style.display = 'none'; }, 4000);
      btn.disabled = false;
      btn.textContent = '‚ö° REFINE AGAIN';
      hrmcRunning = false;
      addMsg('agent', 'ATOMINFER AGENT', 'ü§ñ',
        `<strong>HRMC complete.</strong> ${msg.n_steps} steps ¬∑ Final R=${((fc.R_factor||0)*100).toFixed(1)}% ¬∑ E/atom=${(fc.E_per_atom||0).toFixed(3)} eV ¬∑ Ce=${((fc.x_Ce||0)*100).toFixed(1)}%`);
    } else if (msg.type === 'error') {
      addMsg('agent','ATOMINFER AGENT','ü§ñ',`HRMC error: ${msg.message}`);
    }
  };

  ws.onerror = () => {
    if (overlay) overlay.style.display = 'none';
    btn.disabled = false;
    btn.textContent = '‚ö° REFINE STRUCTURE';
    hrmcRunning = false;
  };

  ws.onclose = () => {
    if (hrmcRunning) {
      hrmcRunning = false;
      btn.disabled = false;
      btn.textContent = '‚ö° REFINE STRUCTURE';
      if (overlay) overlay.style.display = 'none';
    }
  };
}
// ====== END HRMC ======
</script>
</body>
</html>
